<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTI√ìN DE INVENTARIOS - VIBRAS POSITIVAS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #065f46 0%, #0d9488 100%); min-height: 100vh; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); width: 100%; max-width: 420px; border-top: 5px solid #10b981; }
        .login-title { text-align: center; font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px; }
        .login-subtitle { text-align: center; color: #10b981; font-size: 12px; letter-spacing: 3px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s; }
        .btn { padding: 14px 24px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 15px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #10b981; color: white; width: 100%; }
        .btn-success { background: #16a34a; color: white; margin-top: 10px; }
        .btn-logout { background: #ef4444; color: white; padding: 8px 16px; font-size: 13px; border-radius: 10px; }
        .app-container { display: none; min-height: 100vh; background: #f3f4f6; }
        .header { background: linear-gradient(135deg, #065f46 0%, #0d9488 100%); color: white; padding: 15px 20px; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .tabs { display: flex; gap: 5px; background: #e5e7eb; padding: 5px; border-radius: 15px; max-width: 1400px; margin: 20px auto; }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-radius: 10px; font-weight: bold; }
        .tab.active { background: #10b981; color: white; }
        .content-box { background: white; border-radius: 20px; padding: 30px; max-width: 1400px; margin: 0 auto; }
        .table-container { overflow-x: auto; margin-top: 20px; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: left; }
        .text-right { text-align: right; }
        .search-results { position: absolute; background: white; border: 1px solid #ccc; width: 100%; z-index: 100; max-height: 200px; overflow-y: auto; display: none; }
        .search-results.show { display: block; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .hidden { display: none !important; }
        .stat-card { background: #1f2937; color: #34d399; padding: 20px; border-radius: 12px; font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 10px; color: white; z-index: 9999; display: none; }
    </style>
</head>
<body>

<div id="toast" class="toast"></div>

<div id="login-screen" class="login-container">
    <div class="login-box">
        <h1 class="login-title">VIBRAS POSITIVAS</h1>
        <p class="login-subtitle">SISTEMA DE INVENTARIO</p>
        <div id="login-alert"></div>
        <form id="login-form">
            <div class="form-group"><label>Usuario</label><input type="text" id="login-user" required></div>
            <div class="form-group"><label>Contrase√±a</label><input type="password" id="login-pass" required></div>
            <div class="form-group"><label>M√°quina</label><input type="text" id="login-machine" required></div>
            <div class="form-group hidden" id="register-role-group">
                <label>Rol</label>
                <select id="register-role"><option value="capturador">Capturador</option><option value="admin">Administrador</option></select>
            </div>
            <button type="submit" class="btn btn-primary" id="login-btn">Ingresar</button>
            <button type="button" class="btn-logout" id="toggle-register" style="background:none; color:#10b981; width:100%; margin-top:10px;">¬øRegistrarse?</button>
        </form>
    </div>
</div>

<div id="app-screen" class="app-container">
    <header class="header">
        <div class="header-content">
            <div><h1>VIBRAS POSITIVAS</h1><p id="clock">00:00:00</p></div>
            <div style="text-align:right;"><strong id="display-user"></strong><br><span id="display-machine"></span><br>
            <button class="btn-logout" onclick="logout()">Salir</button></div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" data-tab="captura">Capturar</button>
        <button class="tab admin-only" data-tab="consolidado">Consolidado</button>
        <button class="tab admin-only" data-tab="maestro">Maestro</button>
    </div>

    <div class="content-box">
        <div id="tab-captura" class="tab-content active">
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; position:relative;">
                <div class="form-group">
                    <label>Buscar Producto (844 en lista)</label>
                    <input type="text" id="search-product" oninput="searchProducts()">
                    <div id="search-results" class="search-results"></div>
                </div>
                <div class="form-group"><label>Unidad</label><input type="text" id="selected-unit" readonly></div>
                <div class="form-group"><label>Cantidad</label><input type="number" id="input-cantidad" step="0.01"></div>
            </div>
            <button class="btn btn-primary" onclick="registrarConteo()">A√±adir a la lista</button>
            <div class="table-container">
                <table>
                    <thead><tr><th>Producto</th><th>Cant.</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="tabla-conteo"></tbody>
                </table>
            </div>
            <button class="btn btn-success" onclick="enviarInventario()">üì§ Enviar Inventario</button>
        </div>

        <div id="tab-consolidado" class="tab-content">
            <div class="stat-card">Total Liquidado: <span id="stat-total">$0</span></div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Producto</th><th>Und.</th><th>Cant.</th><th>Costo</th><th>Subtotal</th><th>M√°quinas</th></tr></thead>
                    <tbody id="tabla-consolidado"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-maestro" class="tab-content">
            <div class="table-container">
                <table>
                    <thead><tr><th>Producto</th><th>Und.</th><th>Costo</th></tr></thead>
                    <tbody id="tabla-maestro"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const KEYS = { USERS: 'inv_users', PRODUCTOS: 'inv_productos', CONTEOS: 'inv_conteos', CURRENT_USER: 'inv_current_user', LOCAL_CONTEO: 'inv_local_conteo' };

async function sincronizarDesdeGitHub() {
    const url = 'https://raw.githubusercontent.com/haroldco45/gestioninventariovibras/main/data/productos.json';
    try {
        const res = await fetch(url);
        const data = await res.json();
        localStorage.setItem(KEYS.PRODUCTOS, JSON.stringify(data));
        showToast("üì¶ Lista de productos sincronizada");
        if(currentUser?.role === 'admin') renderMaestro();
    } catch(e) { console.error("Error sincronizando", e); }
}

function showToast(msg) { 
    const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block'; t.style.background = '#10b981';
    setTimeout(() => t.style.display = 'none', 3000);
}

const getS = (k) => JSON.parse(localStorage.getItem(k) || '[]');
const setS = (k, d) => localStorage.setItem(k, JSON.stringify(d));

let currentUser = JSON.parse(localStorage.getItem(KEYS.CURRENT_USER));
let localConteo = getS(KEYS.LOCAL_CONTEO);

document.getElementById('login-form').onsubmit = function(e) {
    e.preventDefault();
    const user = document.getElementById('login-user').value.trim();
    const pass = document.getElementById('login-pass').value;
    const machine = document.getElementById('login-machine').value;
    const users = getS(KEYS.USERS);

    if (document.getElementById('login-btn').textContent === 'Registrarse') {
        const role = document.getElementById('register-role').value;
        users.push({ username: user, password: pass, role, machine });
        setS(KEYS.USERS, users);
        location.reload();
    } else {
        const found = users.find(u => u.username === user && u.password === pass);
        if (found) { setS(KEYS.CURRENT_USER, found); location.reload(); }
        else { alert("Credenciales incorrectas"); }
    }
};

document.getElementById('toggle-register').onclick = function() {
    const isReg = this.textContent === 'Inicia sesi√≥n';
    this.textContent = isReg ? '¬øRegistrarse?' : 'Inicia sesi√≥n';
    document.getElementById('login-btn').textContent = isReg ? 'Ingresar' : 'Registrarse';
    document.getElementById('register-role-group').classList.toggle('hidden');
};

function logout() { localStorage.removeItem(KEYS.CURRENT_USER); location.reload(); }

function searchProducts() {
    const q = document.getElementById('search-product').value.toLowerCase();
    const res = document.getElementById('search-results');
    if (!q) { res.classList.remove('show'); return; }
    const filtered = getS(KEYS.PRODUCTOS).filter(p => p.nombre.toLowerCase().includes(q)).slice(0, 15);
    res.innerHTML = filtered.map(p => `<div class="search-item" onclick="selectP('${p.nombre}','${p.unidad}')">${p.nombre}</div>`).join('');
    res.classList.add('show');
}

function selectP(n, u) {
    document.getElementById('search-product').value = n;
    document.getElementById('selected-unit').value = u;
    document.getElementById('search-results').classList.remove('show');
}

function registrarConteo() {
    const n = document.getElementById('search-product').value;
    const c = document.getElementById('input-cantidad').value;
    if (!n || !c) return;
    localConteo.push({ nombre: n, cantidad: c, maquina: currentUser.machine, unidad: document.getElementById('selected-unit').value });
    setS(KEYS.LOCAL_CONTEO, localConteo);
    renderConteoTable();
}

function renderConteoTable() {
    document.getElementById('tabla-conteo').innerHTML = localConteo.map((it, i) => 
        `<tr><td>${it.nombre}</td><td>${it.cantidad}</td><td><button onclick="borrarC(${i})">‚ùå</button></td></tr>`).join('');
}

function borrarC(i) { localConteo.splice(i, 1); setS(KEYS.LOCAL_CONTEO, localConteo); renderConteoTable(); }

function enviarInventario() {
    if (localConteo.length === 0) return;
    const global = getS(KEYS.CONTEOS);
    global.push({ items: [...localConteo], fecha: new Date().toLocaleString() });
    setS(KEYS.CONTEOS, global);
    localConteo = []; setS(KEYS.LOCAL_CONTEO, []);
    renderConteoTable(); showToast("Enviado al consolidado");
}

function cargarConsolidado() {
    const conteos = getS(KEYS.CONTEOS);
    const maestro = getS(KEYS.PRODUCTOS);
    const resumen = {}; let total = 0;

    conteos.forEach(c => c.items.forEach(it => {
        if(!resumen[it.nombre]) {
            const m = maestro.find(p => p.nombre === it.nombre);
            resumen[it.nombre] = { u: it.unidad, cant: 0, costo: m ? m.costo : 0, maq: [] };
        }
        resumen[it.nombre].cant += parseFloat(it.cantidad);
        if(!resumen[it.nombre].maq.includes(it.maquina)) resumen[it.nombre].maq.push(it.maquina);
    }));

    document.getElementById('tabla-consolidado').innerHTML = Object.keys(resumen).map(k => {
        const d = resumen[k]; const sub = d.cant * d.costo; total += sub;
        return `<tr><td>${k}</td><td>${d.u}</td><td>${d.cant}</td><td>$${d.costo}</td><td>$${sub.toLocaleString()}</td><td>${d.maq.join(',')}</td></tr>`;
    }).join('');
    document.getElementById('stat-total').textContent = `$${total.toLocaleString()}`;
}

function renderMaestro() {
    document.getElementById('tabla-maestro').innerHTML = getS(KEYS.PRODUCTOS).map(p => 
        `<tr><td>${p.nombre}</td><td>${p.unidad}</td><td>$${p.costo}</td></tr>`).join('');
}

document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
    t.classList.add('active'); document.getElementById('tab-'+t.dataset.tab).classList.add('active');
    if(t.dataset.tab === 'consolidado') cargarConsolidado();
});

document.addEventListener('DOMContentLoaded', () => {
    sincronizarDesdeGitHub();
    if (currentUser) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').style.display = 'block';
        document.getElementById('display-user').textContent = currentUser.username;
        document.getElementById('display-machine').textContent = currentUser.machine;
        if (currentUser.role !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.remove());
        renderConteoTable();
    }
    setInterval(() => { document.getElementById('clock').textContent = new Date().toLocaleTimeString('es-CO'); }, 1000);
});
</script>
</body>
</html>
